#R file

#Getting set up 
##This script includes data and analyses for MacNeill et al. 2025 "Nectar metabolomes contribute to pollination syndromes". 
##In this repository there are analyses for individual level data, and our the three main hypotheses tested: Chemical pollination syndrome, 
##Passive Leaking, and Phylogenetic signal. Data files needed to run these analyses can be found on the github page, mzXML files for the samples 
##can be found on a massIVE repository here: https://gnps.ucsd.edu/ProteoSAFe/result.jsp?task=e6f30ec057334e87aa5e822b9ff205a9&view=advanced_view


##Step one: Install Packages 
library(picante)
library(ape)
library(adephylo)
library(ade4)
library(phylobase)
library(geiger)
library(phytools)
library(tidyverse)
library(ggplot2)
library(readr)
library(phylosignal)
library(gghighlight)
library(lmerTest)
library(lme4)
library(MASS)
library(viridis)
library(tidyverse)
library(vegan)
library(readr)


#Calculating species averages from Individual averages- Here we calculate for leaves but the process is the same for Nectar 
##Example of calculating species level traits from individual level traits 
##This is also how we would calculate individual level data for individuals which we have multiple samples for (average across the samples to get an individual level profile)


IndLevel<-as.data.frame(Heat_Leaves_IndividualLevel)
IndLevel<-IndLevel[,2:167]
rownames(IndLevel)<-Heat_Leaves_IndividualLevel$row.ID

IndLevel<-t(IndLevel)
IndLevel<-as.data.frame(IndLevel)
IndLevel$"ATTRIBUTE_sppID"<-rownames(IndLevel)


metaInd<-Meta_LeafIndividuals
metaInd$ATTRIBUTE_sppID<-metaInd$SppID
dim(IndLevel)#166 8522

IndLevel_long<-merge(metaInd, IndLevel, by="ATTRIBUTE_sppID")
IndLevel_long<-IndLevel_long%>%dplyr::select(-c("SppID", "ATTRIBUTE_sppID","Pollinator","Species","Salvia"))
dim(IndLevel_long)##166 8522

##This dataframe has one grouping colums (species) that we pulled in from the metadata and the rest are numeric, where we will average across groups to get species averages across individuals 

SppLevel<-IndLevel_long %>%
  group_by(Species2) %>%
  summarise(across(.cols=where(is.numeric), ~ mean(.x, na.rm = TRUE))) 

##SppLevel is the species level means 
dim(IndLevel_long) ##166 8522
dim(SppLevel) ##19 8522
 
SppLevel<-t(SppLevel)


SppLevel<-as.data.frame(SppLevel)


header.true <- function(df) {
  names(df) <- as.character(unlist(df[1,]))
  df[-1,]
}
SppLevel<-header.true(SppLevel)
SppLevel_num<-lapply(SppLevel, as.numeric)
SppLevel_num2<-as.data.frame(SppLevel_num)
is.numeric(SppLevel_num2)##False
is.numeric(SppLevel_num2$Anisacanthus.quadrifidus)##TRUE
rownames(SppLevel_num2)<-rownames(SppLevel)
SppLevel<-SppLevel_num2

#write.csv(SppLevel, file="Heat_SpeciesLevel_traits.csv")
network<-network_file

compounds<-rownames(SppLevel)
edge_edit1<-subset(network, network$CLUSTERID1 %in% compounds)
edge_edit2<-subset(edge_edit1, edge_edit1$CLUSTERID2 %in% compounds)

Edges_export<-edge_edit2
View(Edges_export)
#write.csv(Edges_export, file="Leaves_networkfile.csv")


#Individual Level traits- here we test if individuals group by species 
##ANOSIM, Individual level Leaf traits (Figure S2) 

discscs<-Leaves_IndividualLevel_discscs
rownames(discscs)<-discscs$...1
distance_matrix<-discscs[,2:167]
rownames(distance_matrix)<-rownames(discscs)

dat<-data.matrix(distance_matrix, rownames.force = NA)
rownames(dat)<-colnames(dat)

dis2<-dat
dis2<-as.matrix(dat)

library(vegan)
examples_nmds.all=metaMDS(dis2, k=2, trymax=100)
nmds.point.all=examples_nmds.all$points
data.scores.allsamp<-as.data.frame(vegan::scores(examples_nmds.all))
examples_nmds.all$stress

meta<-Meta_LeafIndividuals
meta<-subset(meta, meta$SppID %in% rownames(data.scores.allsamp))
setdiff(meta$SppID, rownames(data.scores.allsamp))

data.scores.allsamp<-cbind(Row.Names=rownames(data.scores.allsamp),data.scores.allsamp)
arranged.alldata<-data.scores.allsamp%>%arrange(Row.Names)
View(arranged.alldata)

data<-arranged.alldata
target<-rownames(dis2)
print(target)

df2<-data[match(target, data$Row.Names),]
meta2<-meta[match(target, meta$SppID),]

data<-df2
meta<-meta2

data$Species<-meta$Species
data$Pollinator<-meta$Pollinator
data$Pair<-meta$PairMatch
data$species2<-meta$Species2
data$Salvia<-meta$Salvia
View(data)

NMDS_LeafIndividuals<-data

##Test grouping of species in chemical space on dis2, which is a square dissimilarity matrix (an acceptable input for ANOSIM)

identical(colnames(dis2), rownames(dis2))##True
identical(rownames(dis2), data$Row.Names)##True, we are in the right order 

ano.allsamp_LeafIndividuals<-anosim(dis2, data$species2, distance="bray", permutations=999)
print(ano.allsamp_LeafIndividuals)###R=.94, p =.001 

##The NMDS code used to generate figure S2A 
data<-NMDSdata_Leaves_IndividualLevel

fig_LeafIndividuals_2A<-ggplot(data, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 5.5, aes( shape = Pollinator, colour = species2))+ 
    theme(axis.text.y = element_text(colour = "black", size = 12, face = "bold"), 
    axis.title.x = element_text(face = "bold", size = 14, colour = "black"), 
    legend.title = element_text(size = 14, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    labs(x = "NMDS1", colour = "Species", y = "NMDS2", shape = "Pollinator")


fig_LeafIndividuals_2A

#####################################################################################################################################################################################################################################################################################################

#Recalculating with just Salvia species 

dat2<-dat
meta_Ind<-Meta_LeafIndividuals
meta_Ind_sal<-subset(meta_Ind, meta_Ind$Salvia=="Salvia")

dat2<-subset(dat2, rownames(dat2) %in% meta_Ind_sal$SppID)
dat2<-t(dat2)
dat2<-subset(dat2, rownames(dat2) %in% meta_Ind_sal$SppID)
dat<-dat2
dim(dat)##111 111
dis2<-dat
dis2<-as.matrix(dat)

dis2_backup<-dis2

library(vegan)
examples_nmds.all=metaMDS(dis2, k=2, trymax=100)
nmds.point.all=examples_nmds.all$points
data.scores.allsamp<-as.data.frame(vegan::scores(examples_nmds.all))
examples_nmds.all$stress


View(meta_Ind)
meta<-meta_Ind_sal
meta<-subset(meta, meta$SppID %in% rownames(data.scores.allsamp))
setdiff(meta$SppID, rownames(data.scores.allsamp))

data.scores.allsamp<-cbind(Row.Names=rownames(data.scores.allsamp),data.scores.allsamp)
arranged.alldata<-data.scores.allsamp%>%arrange(Row.Names)

data<-arranged.alldata
target<-rownames(dis2)
print(target)

df2<-data[match(target, data$Row.Names),]
meta2<-meta[match(target, meta$SppID),]

data<-df2
meta<-meta2

data$Species<-meta$Species
data$Pollinator<-meta$Pollinator
data$Pair<-meta$PairMatch
data$species2<-meta$Species2
data$Salvia<-meta$Salvia

NMDS_LeafIndividuals_Salvia<-data


ano.sal_LeafIndividuals<-anosim(dis2, data$species2, distance="bray", permutations=999)
print(ano.sal_LeafIndividuals)###R=.88, p =.001 

##Figure S2B 
data<-NMDSdata_Leaves_IndividualLevel_JustSalvia

fig_Leaf_SalviaIndividuals_S2B<-ggplot(data, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 5.5, aes( shape = Pollinator, colour = species2))+ 
    theme(axis.text.y = element_text(colour = "black", size = 12, face = "bold"), 
    axis.title.x = element_text(face = "bold", size = 14, colour = "black"), 
    legend.title = element_text(size = 14, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    labs(x = "NMDS1", colour = "Species", y = "NMDS2")

fig_Leaf_SalviaIndividuals_S2B

#################################################################################################################################
#ANOSIM, Nectar individual Section 

discscs<-Nectar_IndividualLevel_discscs
rownames(discscs)<-discscs$...1
distance_matrix<-discscs[,2:115]
rownames(distance_matrix)<-rownames(discscs)

dat<-distance_matrix

MetaNec<-Meta_NectarIndividuals
dat<-subset(dat, rownames(dat) %in% MetaNec$SppID)
dat<-t(dat)
dat<-subset(dat, rownames(dat) %in% MetaNec$SppID)
View(dat)
colnames(dat)<-rownames(dat)

View(MetaNec)

dis2<-dat
dis2<-as.matrix(dat)

examples_nmds.all=metaMDS(dis2, k=2, trymax=100)
nmds.point.all=examples_nmds.all$points
data.scores.allsamp<-as.data.frame(vegan::scores(examples_nmds.all))
examples_nmds.all$stress###.2309

View(data.scores.allsamp)

library(readr)

View(MetaNec)
meta<-MetaNec
meta<-subset(meta, meta$SppID %in% rownames(data.scores.allsamp))
setdiff(meta$SppID, rownames(data.scores.allsamp))

data.scores.allsamp<-cbind(Row.Names=rownames(data.scores.allsamp),data.scores.allsamp)
arranged.alldata<-data.scores.allsamp%>%arrange(Row.Names)
View(arranged.alldata)

data<-arranged.alldata
target<-rownames(dis2)
print(target)


df2<-data[match(target, data$Row.Names),]
View(df2)

meta2<-meta[match(target, meta$SppID),]

data<-df2
meta<-meta2

data$Species<-meta$Species
data$Pollinator<-meta$Pollinator
data$Pair<-meta$PairMatch
data$species2<-meta$Species2
data$Salvia<-meta$Salvia
View(data)

identical(rownames(dis2), data$Row.Names)##True

ano.NectarIndividuals<-anosim(dis2, data$species2, distance="bray", permutations=999)
print(ano.NectarIndividuals)###R=.43, p =.001 


##Figure S3A
data<-NMDS_Nectar_IndividualLevel

fig_Nectar_Individuals_Fig3A<-ggplot(data, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 5.5, aes( shape = Pollinator, colour = species2))+ 
    theme(axis.text.y = element_text(colour = "black", size = 12, face = "bold"), 
    axis.title.x = element_text(face = "bold", size = 14, colour = "black"), 
    legend.title = element_text(size = 14, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    labs(x = "NMDS1", colour = "Species", y = "NMDS2", shape = "Pollinator")

fig_Nectar_Individuals_Fig3A

#####################################################################################################################################################################################################################################################################################################

#Recalculating, Just Salvia 

View(dat2)
View(meta_Ind)
meta_Ind_sal<-subset(meta, meta$Salvia=="SALVIA")

dat2<-subset(dat, rownames(dat) %in% meta_Ind_sal$SppID)
dat2<-t(dat2)
dat2<-subset(dat2, rownames(dat2) %in% meta_Ind_sal$SppID)
dat<-dat2

dis2<-dat
dis2<-as.matrix(dat)

examples_nmds.all=metaMDS(dis2, k=2, trymax=100)
nmds.point.all=examples_nmds.all$points
data.scores.allsamp<-as.data.frame(vegan::scores(examples_nmds.all))
examples_nmds.all$stress###.20

View(meta_Ind)
meta<-meta_Ind_sal
meta<-subset(meta, meta$SppID %in% rownames(data.scores.allsamp))
setdiff(meta$SppID, rownames(data.scores.allsamp))

data.scores.allsamp<-cbind(Row.Names=rownames(data.scores.allsamp),data.scores.allsamp)
arranged.alldata<-data.scores.allsamp%>%arrange(Row.Names)
data<-arranged.alldata
target<-rownames(dis2)
print(target)

df2<-data[match(target, data$Row.Names),]

meta2<-meta[match(target, meta$SppID),]

data<-df2
meta<-meta2

data$Species<-meta$Species
data$Pollinator<-meta$Pollinator
data$Pair<-meta$PairMatch
data$species2<-meta$Species2
data$Salvia<-meta$Salvia

identical(colnames(dis2), data$Row.Names)##True

ano.NectarSalviaIndividuals<-anosim(dis2, data$species2, distance="bray", permutations=999)
print(ano.NectarSalviaIndividuals)###R=.35, p =.001 

##Figure S3B 
data<-NMDS_Nectar_IndividualLevel_JustSalvia_

fig_NectarSalviaIndividuals_S3B<-ggplot(data, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 5.5, aes( shape = Pollinator, colour = species2))+ 
    theme(axis.text.y = element_text(colour = "black", size = 12, face = "bold"), 
    axis.title.x = element_text(face = "bold", size = 14, colour = "black"), 
    legend.title = element_text(size = 14, colour = "black", face = "bold"), 
    panel.background = element_blank(), panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key=element_blank()) + 
    labs(x = "NMDS1", colour = "Species", y = "NMDS2", shape = "Pollinator")


fig_NectarSalviaIndividuals_S3B

###############################################################################################################################################################################################################################################
##ANOSIM, Species level Leaf traits (Figure 5a,b)

discscs<-Leaf_SpeciesLevel_discscs
rownames(discscs)<-discscs$...1
distance_matrix<-discscs[,2:20]
rownames(distance_matrix)<-rownames(discscs)

dat<-data.matrix(distance_matrix, rownames.force = NA)
rownames(dat)<-colnames(dat)
dis2<-dat
dis2<-as.matrix(dat)

examples_nmds.all=metaMDS(dis2, k=2, trymax=100)
nmds.point.all=examples_nmds.all$points
data.scores.allsamp<-as.data.frame(vegan::scores(examples_nmds.all))
examples_nmds.all$stress###.1357

meta<-SpeciesLevel_meta
meta<-subset(meta, meta$Species3 %in% rownames(data.scores.allsamp))
setdiff(meta$Species3, rownames(data.scores.allsamp))

data.scores.allsamp<-cbind(Row.Names=rownames(data.scores.allsamp),data.scores.allsamp)
arranged.alldata<-data.scores.allsamp%>%arrange(Row.Names)
data<-arranged.alldata
target<-rownames(dis2)
print(target)

## align them in the same order 
df2<-data[match(target, data$Row.Names),]
meta2<-meta[match(target, meta$Species3),]

data<-df2
meta<-meta2

data$Pollinator<-meta$Poll
data$Pair<-meta$PairMatch
data$species2<-meta$Species2
data$species3<-meta$Species3
data$Salvia<-meta$Salvia
View(data)

NMDS_LeafSpecies_AllSpecies<-data

identical(rownames(dis2), data$Row.Names)

ano.LeafSpecies<-anosim(dis2, data$Pollinator, distance="bray", permutations=999)
print(ano.LeafSpecies)###R=-.05, p=.876

##Exact figure 5A 
data<-NMDSdata_LeafSpecies_AllSpecies

fig_LeafSpecies_All<-ggplot(data, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 5.5, aes( shape = Pollinator, colour = Pollinator))+ 
    stat_ellipse(aes(x=NMDS1, y=NMDS2, color= Pollinator))+
  theme(
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key = element_blank()
  ) +
  labs(x = "NMDS1", y = "NMDS2", colour = "Pollinator", shape = "Pollinator")

fig_LeafSpecies_All<-fig_LeafSpecies_All + scale_color_manual(values=c("cornflowerblue","red3"))

fig_LeafSpecies_All

###Just Salvia 
meta_SalviaSpecies<-subset(meta, meta$Salvia=="YES")

dat2<-subset(dat, rownames(dat) %in% meta_SalviaSpecies$Species3)
dat2<-t(dat2)
dat2<-subset(dat2, rownames(dat2) %in% meta_SalviaSpecies$Species3)
dat<-dat2
dis2<-dat
dis2<-as.matrix(dat)

examples_nmds.all=metaMDS(dis2, k=2, trymax=100)
nmds.point.all=examples_nmds.all$points
data.scores.allsamp<-as.data.frame(vegan::scores(examples_nmds.all))
examples_nmds.all$stress###.0.1360

meta<-meta_SalviaSpecies
meta<-subset(meta, meta$Species3 %in% rownames(data.scores.allsamp))
setdiff(meta$Species3, rownames(data.scores.allsamp))

data.scores.allsamp<-cbind(Row.Names=rownames(data.scores.allsamp),data.scores.allsamp)
arranged.alldata<-data.scores.allsamp%>%arrange(Row.Names)

data<-arranged.alldata
target<-rownames(dis2)
print(target)

df2<-data[match(target, data$Row.Names),]
meta2<-meta[match(target, meta$Species3),]
data<-df2
meta<-meta2

data$Pollinator<-meta$Poll
data$Pair<-meta$PairMatch
data$species2<-meta$Species2
data$species3<-meta$Species3
data$Salvia<-meta$Salvia

NMDS_LeafSpecies_Salvia<-data
identical(rownames(dis2), data$Row.Names)

ano.SalviaSpecies_Leaf<-anosim(dis2, data$Pollinator, distance="bray", permutations=999)
print(ano.SalviaSpecies_Leaf)###R=.01, p=.41

###w ellipse 
data<-NMDSdata_LeafSpecies_JustSalvia
  
fig_Leaf_SalivaSpecies_5B<-ggplot(data, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 5.5, aes( shape = Pollinator, colour = Pollinator))+ 
    stat_ellipse(aes(x=NMDS1, y=NMDS2, color= Pollinator))+ 
 theme(
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key = element_blank()
  ) +
  labs(x = "NMDS1", y = "NMDS2", colour = "Pollinator", shape = "Pollinator")

fig_Leaf_SalivaSpecies_5B<-fig_Leaf_SalivaSpecies_5B + scale_color_manual(values=c("cornflowerblue","red3"))

##Fig 5B

fig_Leaf_SalivaSpecies_5B

####################################################################################################################################################################################

#While ANOSIM doesn't detect different grouping between the leaves based on Syndrome, visually it appears the bee-leaves occupy less chemical space so we followed up with a Wilcoxon Rank Sum test. 

####Reduced Variance code in foliar leaves code (Figure 5b) 

cscs.leaves = Leaf_SpeciesLevel_discscs

rownames(cscs.leaves)<-cscs.leaves$...1
distance_matrix<-cscs.leaves[,2:20]
rownames(distance_matrix)<-rownames(cscs.leaves)
cscs.leaves<-distance_matrix

nmds.leaves.salvia = NMDSdata_LeafSpecies_JustSalvia
nmds.leaves.all = NMDSdata_LeafSpecies_AllSpecies

head(nmds.leaves.salvia)
dim(cscs.leaves)##19 19 

###Just Salvia 
cscs.leaves.salvia = cscs.leaves[which(row.names(cscs.leaves) %in% nmds.leaves.salvia$species3), which(names(cscs.leaves) %in% nmds.leaves.salvia$species3)]
dim(cscs.leaves.salvia)
rownames(cscs.leaves.salvia)<-colnames(cscs.leaves.salvia) 
# [1] 13 13

cscs.bee = cscs.leaves.salvia[which(row.names(cscs.leaves.salvia) %in% nmds.leaves.salvia$species3[which(nmds.leaves.salvia$Pollinator == "Bee")]),which(names(cscs.leaves.salvia) %in% nmds.leaves.salvia$species3[which(nmds.leaves.salvia$Pollinator == "Bee")])]
rownames(cscs.bee)<-colnames(cscs.bee)

cscs.bird = cscs.leaves.salvia[which(row.names(cscs.leaves.salvia) %in% nmds.leaves.salvia$species3[which(nmds.leaves.salvia$Pollinator == "Bird")]),which(names(cscs.leaves.salvia) %in% nmds.leaves.salvia$species3[which(nmds.leaves.salvia$Pollinator == "Bird")])]
rownames(cscs.bird)<-colnames(cscs.bird)

cscs.bee

nmds.leaves.salvia$Pollinator
mean.bee = mean(unique(unlist(cscs.bee))[-1])
mean.bee


mean.bird = mean(unique(unlist(cscs.bird))[-1])
mean.bird

diff.obs = mean.bird - mean.bee
diff.obs


mean.bee = mean(unique(unlist(cscs.bee))[-1])

mean.bird = mean(unique(unlist(cscs.bird))[-1])

diff.obs = mean.bird - mean.bee

##Just Salvia
wilcox.test(unique(unlist(cscs.bird))[-1], unique(unlist(cscs.bee))[-1], alt = "greater")
#	Wilcoxon rank sum exact test

#data:  unique(unlist(cscs.bird))[-1] and unique(unlist(cscs.bee))[-1]
#W = 255, p-value = 0.0006366
#alternative hypothesis: true location shift is greater than 0
#



####All species 
dim(cscs.leaves)
# [1] 19 19

cscs.bee = cscs.leaves[which(row.names(cscs.leaves) %in% nmds.leaves.all$species3[which(nmds.leaves.all$Pollinator == "Bee")]),which(names(cscs.leaves) %in% nmds.leaves.all$species3[which(nmds.leaves.all$Pollinator == "Bee")])]
rownames(cscs.bee)<-colnames(cscs.bee)

cscs.bird = cscs.leaves[which(row.names(cscs.leaves) %in% nmds.leaves.all$species3[which(nmds.leaves.all$Pollinator == "Bird")]),which(names(cscs.leaves) %in% nmds.leaves.all$species3[which(nmds.leaves.all$Pollinator == "Bird")])]
rownames(cscs.bird)<-colnames(cscs.bird)


mean.bee = mean(unique(unlist(cscs.bee))[-1])
mean.bee


mean.bird = mean(unique(unlist(cscs.bird))[-1])
mean.bird


diff.obs = mean.bird - mean.bee
diff.obs



##All species
wilcox.test(unique(unlist(cscs.bird))[-1], (unique(unlist(cscs.bee))[-1]), alt = "greater")

#
#	Wilcoxon rank sum exact test
#data:  unique(unlist(cscs.bird))[-1] and (unique(unlist(cscs.bee))[-1])
#W = 1128, p-value = 0.001125
#alternative hypothesis: true location shift is greater than 0

####################################################################################################################################################

discscs<-Nectar_SpeciesLevel_discscs
rownames(discscs)<-discscs$...1
distance_matrix<-discscs[,2:20]
rownames(distance_matrix)<-rownames(discscs)

dat<-data.matrix(distance_matrix, rownames.force = NA)
rownames(dat)<-colnames(dat)

dis2<-dat
dis2<-as.matrix(dat)

examples_nmds.all=metaMDS(dis2, k=2, trymax=100)
nmds.point.all=examples_nmds.all$points
data.scores.allsamp<-as.data.frame(vegan::scores(examples_nmds.all))
examples_nmds.all$stress

meta<-SpeciesLevel_meta
meta<-subset(meta, meta$Species3 %in% rownames(data.scores.allsamp))
setdiff(meta$Species3, rownames(data.scores.allsamp))

data.scores.allsamp<-cbind(Row.Names=rownames(data.scores.allsamp),data.scores.allsamp)
arranged.alldata<-data.scores.allsamp%>%arrange(Row.Names)

data<-arranged.alldata
target<-rownames(dis2)
print(target)

df2<-data[match(target, data$Row.Names),]
meta2<-meta[match(target, meta$Species3),]

data<-df2
meta<-meta2

data$Species<-meta$Species3
data$Pollinator<-meta$Poll
data$species2<-meta$Species2
data$Salvia<-meta$Salvia
data$species3<-meta$Species3

NMDS_NecSpp_all<-data

identical(rownames(dis2), data$Row.Names)
ano.NectarSpecies<-anosim(dis2, data$Pollinator, distance="bray", permutations=999)
print(ano.NectarSpecies)

##Figure version 
data<-NMDSdata_NectarSpecies_AllSpecies

Fig_NectarSpecies_3A<-ggplot(data, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 5.5, aes( shape = Pollinator, colour = Pollinator))+ 
    stat_ellipse(aes(x=NMDS1, y=NMDS2, color= Pollinator))+
    theme(
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key = element_blank()
  ) +
  labs(x = "NMDS1", y = "NMDS2", colour = "Pollinator", shape = "Pollinator")


Fig_NectarSpecies_3A<-Fig_NectarSpecies_3A+ scale_color_manual(values=c("cornflowerblue","red3"))
Fig_NectarSpecies_3A
#####################################################################################################################################################################################################################################################################################################
####Recalculate NMDS with just Salvia 
meta_SalviaSpecies<-subset(meta, meta$Salvia=="YES")

dat2<-subset(dat, rownames(dat) %in% meta_SalviaSpecies$Species3)
dat2<-t(dat2)
dat2<-subset(dat2, rownames(dat2) %in% meta_SalviaSpecies$Species3)
dat<-dat2
dis2<-dat
dis2<-as.matrix(dat)

examples_nmds.all=metaMDS(dis2, k=2, trymax=100)
nmds.point.all=examples_nmds.all$points
data.scores.allsamp<-as.data.frame(vegan::scores(examples_nmds.all))
examples_nmds.all$stress

meta<-meta_SalviaSpecies
meta<-subset(meta, meta$Species3 %in% rownames(data.scores.allsamp))
setdiff(meta$Species3, rownames(data.scores.allsamp))

data.scores.allsamp<-cbind(Row.Names=rownames(data.scores.allsamp),data.scores.allsamp)
arranged.alldata<-data.scores.allsamp%>%arrange(Row.Names)

data<-arranged.alldata
target<-rownames(dis2)
print(target)

df2<-data[match(target, data$Row.Names),]
meta2<-meta[match(target, meta$Species3),]

data<-df2
meta<-meta2

data$Species<-meta$Species
data$Pollinator<-meta$Poll
data$species2<-meta$Species2
data$Salvia<-meta$Salvia
data$species3<-meta$Species3
identical(rownames(dis2), data$Row.Names)##True
NMDS_NecSpp_Salvia<-data

ano.NectarSpeciesSalvia<-anosim(dis2, data$Pollinator, distance="bray", permutations=999)
print(ano.NectarSpeciesSalvia)

###Code for figure 3B 

data<-NMDSdata_NectarSpecies_JustSalvia 
fig_NectarSpecies_Salvia_3B<-ggplot(data, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 5.5, aes( shape = Pollinator, colour = Pollinator))+ 
    stat_ellipse(aes(x=NMDS1, y=NMDS2, color= Pollinator))+
    theme(
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key = element_blank()
  ) +
  labs(x = "NMDS1", y = "NMDS2", colour = "Pollinator", shape = "Pollinator")

fig_NectarSpecies_Salvia_3B<-fig_NectarSpecies_Salvia_3B+ scale_color_manual(values=c("cornflowerblue","red3"))
fig_NectarSpecies_Salvia_3B


##ANOSIM, Nectar Alkaloids all species 
discscs<-Nectar_SpeciesLevel_Alkaloids_discscs
rownames(discscs)<-discscs$...1
distance_matrix<-discscs[,2:20]
rownames(distance_matrix)<-rownames(discscs)

dat<-data.matrix(distance_matrix, rownames.force = NA)
rownames(dat)<-colnames(dat)

dis2<-dat
dis2<-as.matrix(dat)

examples_nmds.all=metaMDS(dis2, k=2, trymax=100)
nmds.point.all=examples_nmds.all$points
data.scores.allsamp<-as.data.frame(vegan::scores(examples_nmds.all))
examples_nmds.all$stress

meta<-SpeciesLevel_meta
meta<-subset(meta, meta$Species3 %in% rownames(data.scores.allsamp))
setdiff(meta$Species3, rownames(data.scores.allsamp))

data.scores.allsamp<-cbind(Row.Names=rownames(data.scores.allsamp),data.scores.allsamp)
arranged.alldata<-data.scores.allsamp%>%arrange(Row.Names)
View(arranged.alldata)

data<-arranged.alldata
target<-rownames(dis2)
print(target)

df2<-data[match(target, data$Row.Names),]
View(df2)

meta2<-meta[match(target, meta$Species3),]
data<-df2
meta<-meta2

data$Species<-meta$Species3
data$Pollinator<-meta$Poll
data$Pair<-meta$PairMatch
data$species2<-meta$Species2
data$Salvia<-meta$Salvia
data$species3<-meta$Species3
View(data)

NMDS_NecSpp_all<-data
identical(rownames(dis2), data$Row.Names)
ano.NecConfSpp_alk<-anosim(dis2, data$Pollinator, distance="bray", permutations=999)
print(ano.NecConfSpp_alk)

simper.AlkAll<-simper(dis2, data$Pollinator)
summary(simper.AlkAll)

##Figure 4a 
data<-NMDSdata_NectarAlkaloids_AllSpecies_forPhylo
fig_Nec_Alkaloids<-ggplot(data, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 5.5, aes( shape = Pollinator, colour = Pollinator))+ 
    stat_ellipse(aes(x=NMDS1, y=NMDS2, color= Pollinator))+
    theme(
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key = element_blank()
  ) +
  labs(x = "NMDS1", y = "NMDS2", colour = "Pollinator", shape = "Pollinator")

fig_Nec_Alkaloids<-fig_Nec_Alkaloids+ scale_color_manual(values=c("cornflowerblue","red3"))
fig_Nec_Alkaloids

#####################################################################################################################################################################################################################################################################################################
#Recalculating with just Salvia 

meta_Spp_sal<-subset(meta, meta$Salvia=="YES")

dat2<-subset(dat, rownames(dat) %in% meta_Spp_sal$Species3)
dat2<-t(dat2)
dat2<-subset(dat2, rownames(dat2) %in% meta_Spp_sal$Species3)
dat<-dat2

dis2<-dat
dis2<-as.matrix(dat)

examples_nmds.all=metaMDS(dis2, k=2, trymax=100)
nmds.point.all=examples_nmds.all$points
data.scores.allsamp<-as.data.frame(vegan::scores(examples_nmds.all))
examples_nmds.all$stress###.126

meta<-meta_Spp_sal
meta<-subset(meta, meta$Species3 %in% rownames(data.scores.allsamp))
setdiff(meta$Species3, rownames(data.scores.allsamp))

data.scores.allsamp<-cbind(Row.Names=rownames(data.scores.allsamp),data.scores.allsamp)
arranged.alldata<-data.scores.allsamp%>%arrange(Row.Names)


data<-arranged.alldata
target<-rownames(dis2)
print(target)

df2<-data[match(target, data$Row.Names),]
View(df2)

meta2<-meta[match(target, meta$Species3),]
data<-df2
meta<-meta2


data$Species<-meta$Species
data$Pollinator<-meta$Poll
data$Pair<-meta$PairMatch
data$species2<-meta$Species2
data$Salvia<-meta$Salvia
data$species3<-meta$Species3
View(data)

identical(rownames(dis2), data$Row.Names)##True
NMDS_NecSpp_Salvia<-data

ano.NectarAlkaloids_Salvia<-anosim(dis2, data$Pollinator, distance="bray", permutations=999)
print(ano.NectarAlkaloids_Salvia)###R=.5608, p =.007


simper.All<-simper(dis2, data$Pollinator)
summary(simper.All)

#fig4b
data<-NMDSdata_NectarAlkaloids_JustSalvia_forPhylo
fig_NectarAlkaloids_Salvia<-ggplot(data, aes(x = NMDS1, y = NMDS2)) + 
    geom_point(size = 5.5, aes( shape = Pollinator, colour = Pollinator))+ 
    stat_ellipse(aes(x=NMDS1, y=NMDS2, color= Pollinator))+
    theme(
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill = NA, size = 1.2),
    legend.key = element_blank()
  ) +
  labs(x = "NMDS1", y = "NMDS2", colour = "Pollinator", shape = "Pollinator")


fig_NectarAlkaloids_Salvia<-fig_NectarAlkaloids_Salvia+ scale_color_manual(values=c("cornflowerblue","red3"))
fig_NectarAlkaloids_Salvia

#####################################################################################################################################################################################################################################################################################################
#####################################################################################################################################################################################################################################################################################################

##T test for alkaloids 

NecAlks<-Heat_Nectar_SpeciesLevel_Alkaloids
NecAlks<-as.data.frame(NecAlks)
NecAlks<-NecAlks[,2:20]
rownames(NecAlks)<-Heat_Nectar_SpeciesLevel_Alkaloids$row.ID

col_sums <- colSums(NecAlks)
df<-as.data.frame(col_sums)

df$spp<-rownames(df)

bird<-c("Anisacanthus.quadrifidus","Salvia.blepharophylla","Salvia.coccinea","Salvia.darcyi","Salvia.greggii","Salvia.microphylla","Salvia.regla","Salvia.roemeriana","Scutellaria.suffrutescens","Stachys.coccinea")

bird_sal<-c("Salvia.blepharophylla","Salvia.coccinea","Salvia.darcyi","Salvia.greggii","Salvia.microphylla","Salvia.regla","Salvia.roemeriana")

bee<-c("Physostegia.virginiana","Ruellia.brittoniana","Salvia.azurea","Salvia.ballotiflora","Salvia.chionophylla","Salvia.farinacea","Salvia.leucantha","Salvia.sinaloensis","Scutellaria.wrightii")

bee_sal<-c("Salvia.azurea","Salvia.ballotiflora","Salvia.chionophylla","Salvia.farinacea","Salvia.leucantha","Salvia.sinaloensis")

df_bee<-subset(df, df$spp %in% bee)
mean(df_bee$col_sums)#987097.2

vec_beeconc<-df_bee$col_sums

df_bird<-subset(df, df$spp %in% bird)
mean(df_bird$col_sums)#169570.2

vec_birdconc<-df_bird$col_sums

df_bee_sal<-subset(df, df$spp %in% bee_sal)
mean(df_bee_sal$col_sums)#1435084
vec_beeconc_sal<-df_bee_sal$col_sums

df_bird_sal<-subset(df, df$spp %in% bird_sal)
mean(df_bird_sal$col_sums)#39974.13
vec_birdconc_sal<-df_bird_sal$col_sums

##t-test section 

t.test.all<-t.test(vec_beeconc, vec_birdconc)
print(t.test.all)
##t = 2.1462, df = 10.136, p-value = 0.05707 

t.test.sal<-t.test(vec_beeconc_sal, vec_birdconc_sal)
print(t.test.sal)
##t = 3.2339, df = 5.0087, p-value = 0.02305

#####################################################################################################################################################################################################################################################################################################
#####################################################################################################################################################################################################################################################################################################

#Phylogenetic signal tests 
##All species Nectar, Moran test 

mytree<-multi2di(Full_tree)
print(mytree$tip.label)
print(mytree$edge.length)
plot(mytree)

NMDS<-NMDSdata_NectarSpecies_AllSpecies
print(mytree$tip.label)

intersect(mytree$tip.label, NMDS$species4)
NMDS2<-subset(NMDS, NMDS$species4 %in% mytree$tip.label)
NMDS3<-NMDS2[,3:4]
rownames(NMDS3)<-NMDS2$species4


phylotraits<-phylo4d(mytree, NMDS3)
plot(phylotraits)
moran.test <- adephylo::abouheif.moran(phylotraits,method="Abouheif")
print(moran.test)



###Salvia Species Nectar, Moran 
mytree<-multi2di(Salvia_tree)
print(mytree$tip.label)
plot(mytree)

NMDS<-NMDSdata_NectarSpecies_JustSalvia


print(mytree$tip.label)

intersect(mytree$tip.label, NMDS$species4)
NMDS2<-subset(NMDS, NMDS$species4 %in% mytree$tip.label)
NMDS3<-NMDS2[,3:4]
rownames(NMDS3)<-NMDS2$species4


phylotraits<-phylo4d(mytree, NMDS3)
moran.test <- adephylo::abouheif.moran(phylotraits,method="Abouheif")
print(moran.test)



###Leaves, All species 
mytree<-multi2di(Full_tree)
print(mytree$tip.label)
plot(mytree)

NMDS<-NMDSdata_LeafSpecies_AllSpecies
print(mytree$tip.label)

NMDS2<-subset(NMDS, NMDS$species4 %in% mytree$tip.label)
NMDS3<-NMDS2[,3:4]
rownames(NMDS3)<-NMDS2$species4


phylotraits<-phylo4d(mytree, NMDS3)
plot(phylotraits)
moran.test <- adephylo::abouheif.moran(phylotraits,method="Abouheif")
print(moran.test)


###Leaves, just Salvia 

mytree<-multi2di(Salvia_tree)
print(mytree$tip.label)
plot(mytree)

NMDS<-NMDSdata_LeafSpecies_JustSalvia

print(mytree$tip.label)

intersect(mytree$tip.label, NMDS$species4)
#setdiff(mytree22$tip.label, rownames(pcatest2))
NMDS2<-subset(NMDS, NMDS$species4 %in% mytree$tip.label)
NMDS3<-NMDS2[,3:4]
rownames(NMDS3)<-NMDS2$species4

phylotraits<-phylo4d(mytree, NMDS3)
moran.test <- adephylo::abouheif.moran(phylotraits,method="Abouheif")
print(moran.test)

###Nectar Alkaloids, All species 
mytree<-multi2di(Full_tree)
print(mytree$tip.label)
print(mytree$edge.length)
plot(mytree)

NMDS<-NMDSdata_NectarAlkaloids_AllSpecies_forPhylo
print(mytree$tip.label)

intersect(mytree$tip.label, NMDS$species3)
NMDS2<-subset(NMDS, NMDS$species3 %in% mytree$tip.label)
NMDS3<-NMDS2[,3:4]
rownames(NMDS3)<-NMDS2$species3


phylotraits<-phylo4d(mytree, NMDS3)
plot(phylotraits)
moran.test <- adephylo::abouheif.moran(phylotraits,method="Abouheif")
print(moran.test)


###Nectar Alkaloids, just Salvia 

mytree<-multi2di(Salvia_tree)
print(mytree$tip.label)
plot(mytree)

NMDS<-NMDSdata_NectarAlkaloids_JustSalvia_forPhylo

print(mytree$tip.label)

intersect(mytree$tip.label, NMDS$species3)
#setdiff(mytree22$tip.label, rownames(pcatest2))
NMDS2<-subset(NMDS, NMDS$species3 %in% mytree$tip.label)
NMDS3<-NMDS2[,3:4]
rownames(NMDS3)<-NMDS2$species3


phylotraits<-phylo4d(mytree, NMDS3)
plot(phylotraits)
moran.test <- adephylo::abouheif.moran(phylotraits,method="Abouheif")
print(moran.test)

#####################################################################################################################################################################################################################################################################################################
Blomberg's K 
#####################################################################################################################################################################################################################################################################################################
##Nectar, All species 

Tree_All<-multi2di(Full_tree)
order<-Full_tree$tip.label
print(order)
plot(Full_tree)

NMDS_NecAll<-NMDSdata_NectarSpecies_AllSpecies
NMDS_NecAll2<-NMDS_NecAll%>%filter(species4 %in% order)%>%arrange(match(species4,order))
NecAllTrait<-NMDS_NecAll2$NMDS1
names(NecAllTrait)<-NMDS_NecAll2$species4

phylosig(Tree_All, NecAllTrait, method="K", test=TRUE, nsim=999)

##Nectar alkaloids, All species 

NMDS_NecAllAlk<-NMDSdata_NectarAlkaloids_AllSpecies_forPhylo
NMDS_NecAllAlk2<-NMDS_NecAllAlk%>%filter(species3 %in% order)%>%arrange(match(species3,order))
NecAllAlkTrait<-NMDS_NecAllAlk2$NMDS1
names(NecAllAlkTrait)<-NMDS_NecAllAlk2$species3

phylosig(Tree_All, NecAllAlkTrait, method="K", test=TRUE, nsim=999)

##Leaves, All species 

NMDS_LeafAll<-NMDSdata_LeafSpecies_AllSpecies
NMDS_LeafAll2<-NMDS_LeafAll%>%filter(species4 %in% order)%>%arrange(match(species4,order))
LeafAllTrait<-NMDS_LeafAll2$NMDS1
names(LeafAllTrait)<-NMDS_LeafAll2$species4

phylosig(Tree_All, LeafAllTrait, method="K", test=TRUE, nsim=999)


##############################Salvia subsets 

SalTree<-multi2di(Salvia_tree)
order<-Salvia_tree$tip.label
plot(Salvia_tree)

##Nectar, Just Salvia 

NMDS_NecSal<-NMDSdata_NectarSpecies_JustSalvia
NMDS_NecSal2<-NMDS_NecSal%>%filter(species4 %in% order)%>%arrange(match(species4,order))
NecSalTrait<-NMDS_NecSal2$NMDS1
names(NecSalTrait)<-NMDS_NecSal2$species4
phylosig(SalTree, NecSalTrait, method="K", test=TRUE, nsim=999)

##Nectar alkaloids, Just Salvia 

NMDS_NecSalAlk<-NMDSdata_NectarAlkaloids_JustSalvia_forPhylo
NMDS_NecSalAlk2<-NMDS_NecSalAlk%>%filter(species3 %in% order)%>%arrange(match(species3,order))
NecSalAlkTrait<-NMDS_NecSalAlk2$NMDS1
names(NecSalAlkTrait)<-NMDS_NecSalAlk2$species3
phylosig(SalTree, NecSalAlkTrait, method="K", test=TRUE, nsim=999)

##Leaves, Just Salvia 

NMDS_LeafSal<-NMDSdata_LeafSpecies_JustSalvia
NMDS_LeafSal2<-NMDS_LeafSal%>%filter(species4 %in% order)%>%arrange(match(species4,order))
LeafSalTrait<-NMDS_LeafSal2$NMDS1
names(LeafSalTrait)<-NMDS_LeafSal2$species4
phylosig(SalTree, LeafSalTrait, method="K", test=TRUE, nsim=999)

##Example, a drawing barplot
clado<-read.newick(file="TrimmedTree_Cladogram.newick")
mytree<-multi2di(clado)
order<-clado$tip.label
print(order)


NMDS_NecAll<-NMDSdata_NectarSpecies_AllSpecies
NMDS_NecAll2<-NMDS_NecAll%>%filter(species4 %in% order)%>%arrange(match(species4,order))

NecAllTrait<-NMDS_NecAll2$NMDS1
names(NecAllTrait)<-NMDS_NecAll2$species4
phylotraits<-phylo4d(mytree, NecAllTrait)
plot(phylotraits)
barplot(phylotraits, bar.col =c("red3","cornflowerblue","cornflowerblue","red3","red3","cornflowerblue","red3","cornflowerblue","red3","cornflowerblue","red3","red3","red3","cornflowerblue","cornflowerblue","red3","red3","cornflowerblue","cornflowerblue"))

##Matches figure 3c 

#####################################################################################################################################################################################################################################################################################################
#####################################################################################################################################################################################################################################################################################################



#Passive leaking hypothesis section- Here we subset for individuals for which we have both leaves and nectar, and then filter for compounds that appear in both tissue types to ask if concentration in nectar is predicted by concentration in leaves.


##First, we load individual level meta data for both leaves and nectar 
MetaNecInd<-Meta_NectarIndividuals
MetaLeafInd<-Meta_LeafIndividuals


##Find individuals that have both leaves and nectar 
keeps<-intersect(MetaNecInd$SppID, MetaLeafInd$SppID)
length(keeps)##86 individuals
MetaBoth<-subset(Meta_NectarIndividuals, Meta_NectarIndividuals$SppID %in% keeps)
MetaBoth$ATTRIBUTE_sppID<-MetaBoth$SppID

MetaBoth<-subset(MetaNecInd, MetaNecInd$SppID %in% keeps)

###Filter heat.real ind levels to just include these individuals 
HeatNecInd<-Heat_Nectar_IndividualLevel
HeatNecInd<-as.data.frame(HeatNecInd)
rownames(HeatNecInd)<-HeatNecInd$row.ID
HeatNecInd<-HeatNecInd[,2:115]

HeatNecInd<-HeatNecInd%>%dplyr::select(keeps)


HeatLeafInd<-Heat_Leaves_IndividualLevel
HeatLeafInd<-as.data.frame(HeatLeafInd)
rownames(HeatLeafInd)<-HeatLeafInd$row.ID
HeatLeafInd<-HeatLeafInd[,2:167]


HeatLeafInd<-HeatLeafInd%>%dplyr::select(keeps)
identical(colnames(HeatNecInd), colnames(HeatLeafInd))##True

##First we filter for compounds that occur in both tissue types at the species level (meaning the occur in the leaf-metabolome and nectar-metabolome of the study overall)
bothComps1<-intersect(rownames(HeatNecInd), rownames(HeatLeafInd))
HeatNecInd<-subset(HeatNecInd, rownames(HeatNecInd) %in% bothComps1)
HeatLeafInd<-subset(HeatLeafInd, rownames(HeatLeafInd) %in% bothComps1)

df1<-HeatNecInd
df2<-HeatLeafInd

identical(rownames(df1), rownames(df2))
identical(colnames(df1), colnames(df2))##True

##Now we have two data frames with the same dimensions, columns are individuals and rows are compounds in both tissues, one is filled with the leaf relative abundances the other with the nectar relative abundances. We now want to remove any values where for each individual, there isn't a value in both dataframes (as passive leaking would be interested in compounds where for each individual it's in both leaves and nectar)

df1<-as.data.frame.matrix(df1)
df2<-as.data.frame.matrix(df2)

# Create the filtered matrices where only non-zero values in both matrices are kept
filtered_df1 <- df1 * (df1 != 0 & df2 != 0)
filtered_df2 <- df2 * (df1 != 0 & df2 != 0)

# Print the results
print(filtered_df1)
print(filtered_df2)

###Ok now we have the filtered versions in dataframes, we combine them

df_Nec<-filtered_df1
long_df_Nec <- df_Nec %>%
  rownames_to_column("rowname") %>%
  pivot_longer(cols = -rowname, 
               names_to = "Individual", 
               values_to = "NectarConc")

# Check the reshaped data frame
head(long_df_Nec)
long_df_Nec<-subset(long_df_Nec, long_df_Nec$NectarConc!=0)

length(unique(long_df_Nec$rowname))##115 unique compounds that are carried into both tissue types (in passive leaking)


df_Leaf<-filtered_df2
long_df_Leaf <- df_Leaf %>%
  rownames_to_column("rowname") %>%
  pivot_longer(cols = -rowname, 
               names_to = "Individual", 
               values_to = "LeafConc")

# Check the reshaped data frame
head(long_df_Leaf)
long_df_Leaf<-subset(long_df_Leaf, long_df_Leaf$LeafConc!=0)

length(unique(long_df_Leaf$rowname))##115

intersect(colnames(long_df_Leaf), colnames(long_df_Nec))
intersect(long_df_Leaf$rowname, long_df_Nec$rowname)##115

merged_df <- merge(long_df_Leaf, long_df_Nec, by = c("rowname", "Individual"))


###Add in classifications and species ID 

##starting with species ID and Pollinator ID which comes from meta 
meta<-MetaBoth
colnames(meta)[colnames(meta) == "SppID"] <- "Individual"
colnames(meta)[colnames(meta) == "Pollinator"] <- "Pollinator"
result <- merge(merged_df, meta[, c("Individual", "Species2", "Pollinator")], by = "Individual", all.x = TRUE)


###Work in the classifcation data 
conf<-MasterConf
result$row.ID<-result$rowname

result<-result%>%dplyr::select(-"rowname")
result2 <- merge(result, conf[, c("row.ID" ,"NPC.pathway", "NPC.superclass", "NPC.class")], by = "row.ID", all.x = TRUE)

#write.csv(result2, file="Individual_PassiveLeaking_date.csv")

##Manually quality check a few values 

#some compounds that made it through the workflow 
#Comp 1429 in SalBal 1, in HeatNecInd has 3225247.07 and in HeatLeafInd has 4022.9876 and in result2 these values are unchanged (3225247.1, 4022.988) 

#Comp 18091 in SalLeu 5, in HeatNecInd has 4920.012 and in HeatLeafInd has 2631673.890 and in result2 these values are unchanged (4920.012, 2631673.890) 

##Comp 500 in SalFar 2, in HeatNecInd has 1266115.90 and in HeatLeafInd has 9334.341 and in result2 these values are unchanged (1266115.900, 9334.341)




###Passive leaking models and figures 



library(lme4)
update.packages("lme4")
update.packages("lmerTest")



reg<-Individual_PassiveLeaking

dim(reg)#263, but some of these are duplicates as they occur in multiple individuals and species 
reg$Leaves<-reg$LeafConc
reg$Nectar<-reg$NectarConc
reg$Species<-reg$ATTRIBUTE_species

levels(as.factor(reg$Species))

reglog = reg
reglog$Nectar = log10(reglog$Nectar + 1)
reglog$Leaves = log10(reglog$Leaves + 1)

############Model all species
mod = lmer(reglog$Nectar ~ reglog$Leaves + (1 + reglog$Leaves|Species) + (1 + reglog$Leaves|Pollinator) + (1|Individual) , data = reglog)
summary(mod)


####reglog$Leaves -0.01516    0.21809  1.07503  -0.070    0.955  

levels(as.factor(reglog$Species))

plot(reglog$Nectar ~ reglog$Leaves)

colvec = rep("black", nrow(reglog))

colvec[which(reglog$Species == "Physostegia_virginiana")] = "steelblue1" ##sv 
colvec[which(reglog$Species == "Ruellia_brittoniana")] = "slateblue2"
colvec[which(reglog$Species == "Scutellaria_wrightii")] = "skyblue1"
colvec[which(reglog$Species == "Salvia_sinaloensis")] = "blue"
colvec[which(reglog$Species == "Salvia_ballotiflora")] = "dodgerblue3"
colvec[which(reglog$Species == "Salvia_chionophylla")] = "dodgerblue"
colvec[which(reglog$Species == "Salvia_azurea")] = "deepskyblue1"
colvec[which(reglog$Species == "Salvia_farinaceae")] = "lightslateblue"
colvec[which(reglog$Species == "Salvia_leucantha")] = "purple1"
colvec[which(reglog$Species == "Anisacanthus_quadrifidus")] = "tomato1"
colvec[which(reglog$Species == "Scutellaria_suffrutescens")] = "tomato3"
colvec[which(reglog$Species == "Stachys_Coccinea")] = "goldenrod1"
colvec[which(reglog$Species == "Salvia_darcyi")] = "orangered1"
colvec[which(reglog$Species == "Salvia_coccinea")] = "red1"
colvec[which(reglog$Species == "Salvia_blepharophylla")] = "red4"
colvec[which(reglog$Species == "Salvia_roemeriana")] = "firebrick3"
colvec[which(reglog$Species == "Salvia_regla")] = "brown2"
colvec[which(reglog$Species == "Salvia_greggii")] = "darkorange1"
colvec[which(reglog$Species == "Salvia_microphylla")] = "orange1"

shapevec <- rep(16, nrow(reglog)) 
shapevec[which(reglog$Species == "Physostegia_virginiana")] = 1
shapevec[which(reglog$Species == "Ruellia_brittoniana")] = 2
shapevec[which(reglog$Species == "Scutellaria_wrightii")] = 3
shapevec[which(reglog$Species == "Salvia_sinaloensis")] = 4
shapevec[which(reglog$Species == "Salvia_ballotiflora")] = 5
shapevec[which(reglog$Species == "Salvia_chionophylla")] = 6
shapevec[which(reglog$Species == "Salvia_azurea")] = 7
shapevec[which(reglog$Species == "Salvia_farinaceae")] = 8
shapevec[which(reglog$Species == "Salvia_leucantha")] = 9
shapevec[which(reglog$Species == "Anisacanthus_quadrifidus")] = 10
shapevec[which(reglog$Species == "Scutellaria_suffrutescens")] = 11
shapevec[which(reglog$Species == "Stachys_Coccinea")] = 12
shapevec[which(reglog$Species == "Salvia_darcyi")] = 13
shapevec[which(reglog$Species == "Salvia_coccinea")] = 14
shapevec[which(reglog$Species == "Salvia_blepharophylla")] = 15
shapevec[which(reglog$Species == "Salvia_roemeriana")] = 16
shapevec[which(reglog$Species == "Salvia_regla")] = 17
shapevec[which(reglog$Species == "Salvia_greggii")] = 18
shapevec[which(reglog$Species == "Salvia_microphylla")] = 19


plot(reglog$Nectar ~ reglog$Leaves, pch = shapevec, col = colvec)

##Figure S3A
PassiveLeakingPlot_AllSpp<-plot(reglog$Nectar ~ reglog$Leaves, pch = shapevec, col = colvec)

#reglog$Leaves -0.01516    0.21809  1.07503  -0.070    0.955  
##slope = -0.01516, p=0.955  no relationship/trend 


##We can look at the coefficients 
coef(mod)$Species
c<-coef(mod)$Species
c
#####################################################################################################################################################################################################################################################################################################
#Just Salvia Species 
reglog.salv = reglog[grep("Salvia", reglog$Species),]

head(reglog.salv)

mod = lmer(reglog.salv$Nectar ~ reglog.salv$Leaves + (1 + reglog.salv$Leaves|Species) + (1 + reglog.salv$Leaves|Pollinator) + (1|Individual) , data = reglog.salv)

summary(mod)
#reglog.salv$Leaves  -0.1130     0.3252  0.9126  -0.348    0.791
##slope = -0.1130, p=0.791  no relationship/trend 

levels(as.factor(reglog.salv$Species))


plot(reglog.salv$Nectar ~ reglog.salv$Leaves)

colvec = rep("black", nrow(reglog.salv))
colvec[which(reglog.salv$Species == "Salvia_sinaloensis")] = "blue"
colvec[which(reglog.salv$Species == "Salvia_ballotiflora")] = "dodgerblue3"
colvec[which(reglog.salv$Species == "Salvia_chionophylla")] = "dodgerblue"
colvec[which(reglog.salv$Species == "Salvia_azurea")] = "deepskyblue1"
colvec[which(reglog.salv$Species == "Salvia_farinaceae")] = "lightslateblue"
colvec[which(reglog.salv$Species == "Salvia_leucantha")] = "purple1"
colvec[which(reglog.salv$Species == "Salvia_darcyi")] = "orangered1"
colvec[which(reglog.salv$Species == "Salvia_coccinea")] = "red1"
colvec[which(reglog.salv$Species == "Salvia_blepharophylla")] = "red4"
colvec[which(reglog.salv$Species == "Salvia_roemeriana")] = "firebrick3"
colvec[which(reglog.salv$Species == "Salvia_regla")] = "brown2"
colvec[which(reglog.salv$Species == "Salvia_greggii")] = "darkorange1"
colvec[which(reglog.salv$Species == "Salvia_microphylla")] = "orange1"


shapevec <- rep(16, nrow(reglog)) 
shapevec[which(reglog.salv$Species == "Salvia_sinaloensis")] = 4
shapevec[which(reglog.salv$Species == "Salvia_ballotiflora")] = 5
shapevec[which(reglog.salv$Species == "Salvia_chionophylla")] = 6
shapevec[which(reglog.salv$Species == "Salvia_azurea")] = 7
shapevec[which(reglog.salv$Species == "Salvia_farinaceae")] = 8
shapevec[which(reglog.salv$Species == "Salvia_leucantha")] = 9
shapevec[which(reglog.salv$Species == "Salvia_darcyi")] = 13
shapevec[which(reglog.salv$Species == "Salvia_coccinea")] = 14
shapevec[which(reglog.salv$Species == "Salvia_blepharophylla")] = 15
shapevec[which(reglog.salv$Species == "Salvia_roemeriana")] = 16
shapevec[which(reglog.salv$Species == "Salvia_regla")] = 17
shapevec[which(reglog.salv$Species == "Salvia_greggii")] = 18
shapevec[which(reglog.salv$Species == "Salvia_microphylla")] = 19



plot(reglog.salv$Nectar ~ reglog.salv$Leaves, pch = shapevec, col = colvec)



PassiveLeakingPlot_AllSal<-plot(reglog.salv$Nectar ~ reglog.salv$Leaves, pch = shapevec, col = colvec)
#####################################################################################################################################################################################################################################################################################################
#All bee species
reglog.bee = reglog[which(reglog$Pollinator == "BEE"),]
reglog.bird = reglog[which(reglog$Pollinator == "BIRD"),]

mod = lmer(reglog.bee$Nectar ~ reglog.bee$Leaves + (1 + reglog.bee$Leaves|Species) + (1|Individual) , data = reglog.bee)

summary(mod)
#reglog.bee$Leaves  -0.2378     0.1904  4.2753  -1.248 0.275859  


##Figure for all bee 
levels(as.factor(reglog.bee$Species))

plot(reglog.bee$Nectar ~ reglog.bee$Leaves)

#colvec = rep("black", nrow(reglog.bee))

colvec[which(reglog.bee$Species == "Physostegia_virginiana")] = "steelblue1"
colvec[which(reglog.bee$Species == "Ruellia_brittoniana")] = "slateblue2"
colvec[which(reglog.bee$Species == "Scutellaria_wrightii")] = "skyblue1"
colvec[which(reglog.bee$Species == "Salvia_sinaloensis")] = "blue"
colvec[which(reglog.bee$Species == "Salvia_ballotiflora")] = "dodgerblue3"
colvec[which(reglog.bee$Species == "Salvia_chionophylla")] = "dodgerblue"
colvec[which(reglog.bee$Species == "Salvia_azurea")] = "deepskyblue1"
colvec[which(reglog.bee$Species == "Salvia_farinaceae")] = "lightslateblue"
colvec[which(reglog.bee$Species == "Salvia_leucantha")] = "purple1"


shapevec = rep(16, nrow(reglog.bee))
shapevec <- rep(16, nrow(reglog)) 
shapevec[which(reglog.bee$Species == "Physostegia_virginiana")] = 1
shapevec[which(reglog.bee$Species == "Ruellia_brittoniana")] = 2
shapevec[which(reglog.bee$Species == "Scutellaria_wrightii")] = 3
shapevec[which(reglog.bee$Species == "Salvia_sinaloensis")] = 4
shapevec[which(reglog.bee$Species == "Salvia_ballotiflora")] = 5
shapevec[which(reglog.bee$Species == "Salvia_chionophylla")] = 6
shapevec[which(reglog.bee$Species == "Salvia_azurea")] = 7
shapevec[which(reglog.bee$Species == "Salvia_farinaceae")] = 8
shapevec[which(reglog.bee$Species == "Salvia_leucantha")] = 9




plot(reglog.bee$Nectar ~ reglog.bee$Leaves, pch = shapevec, col = colvec)

PassiveLeakingPlot_AllBeeSpp<-plot(reglog.bee$Nectar ~ reglog.bee$Leaves, pch = shapevec, col = colvec)

#####################################################################################################################################################################################################################################################################################################
#All bird species

mod = lmer(reglog.bird$Nectar ~ reglog.bird$Leaves + (1 + reglog.bird$Leaves|Species) + (1|Individual) , data = reglog.bird)

summary(mod)

##reglog.bird$Leaves   0.1784     0.2061 6.0045   0.865  0.42002  

levels(as.factor(reglog.bird$Species))

plot(reglog.bird$Nectar ~ reglog.bird$Leaves)

colvec = rep("black", nrow(reglog.bird))

colvec[which(reglog.bird$Species == "Anisacanthus_quadrifidus")] = "tomato1"
colvec[which(reglog.bird$Species == "Scutellaria_suffrutescens")] = "tomato3"
colvec[which(reglog.bird$Species == "Stachys_Coccinea")] = "goldenrod1"
colvec[which(reglog.bird$Species == "Salvia_darcyi")] = "orangered1"
colvec[which(reglog.bird$Species == "Salvia_coccinea")] = "red1"
colvec[which(reglog.bird$Species == "Salvia_blepharophylla")] = "red4"
colvec[which(reglog.bird$Species == "Salvia_roemeriana")] = "firebrick3"
colvec[which(reglog.bird$Species == "Salvia_regla")] = "brown2"
colvec[which(reglog.bird$Species == "Salvia_greggii")] = "darkorange1"
colvec[which(reglog.bird$Species == "Salvia_microphylla")] = "orange1"

shapevec = rep(17, nrow(reglog.bird))
shapevec[which(reglog.bird$Species == "Anisacanthus_quadrifidus")] = 10
shapevec[which(reglog.bird$Species == "Scutellaria_suffrutescens")] = 11
shapevec[which(reglog.bird$Species == "Stachys_Coccinea")] = 12
shapevec[which(reglog.bird$Species == "Salvia_darcyi")] = 13
shapevec[which(reglog.bird$Species == "Salvia_coccinea")] = 14
shapevec[which(reglog.bird$Species == "Salvia_blepharophylla")] = 15
shapevec[which(reglog.bird$Species == "Salvia_roemeriana")] = 16
shapevec[which(reglog.bird$Species == "Salvia_regla")] = 17
shapevec[which(reglog.bird$Species == "Salvia_greggii")] = 18
shapevec[which(reglog.bird$Species == "Salvia_microphylla")] = 19


plot(reglog.bird$Nectar ~ reglog.bird$Leaves, pch = shapevec, col = colvec)

PassiveLeakingPlot_AllBirdSpp<-plot(reglog.bird$Nectar ~ reglog.bird$Leaves, pch = shapevec, col = colvec)










